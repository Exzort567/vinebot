{% extends 'base.html' %}
{% load static %}

{% block title %}VineBot{% endblock %}

{% block content %}
<div class="bg-gray-800 text-gray-200 flex h-screen overflow-hidden">

    <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-30 hidden lg:hidden" onclick="toggleSidebar()"></div>

    <aside id="sidebar" class="bg-gray-900 w-64 h-full flex flex-col p-4 fixed lg:relative transition-all duration-300 ease-in-out -translate-x-full lg:translate-x-0 z-40">
        <div id="sidebar-content" class="h-full flex flex-col min-w-[224px]">
            <div class="flex items-center justify-between mb-8">
                <h1 class="text-2xl font-bold text-white"><span class="text-green-300">Vine</span><span class="text-purple-400">Bot</span></h1>
                <button onclick="toggleSidebar()" class="lg:hidden p-1 rounded-md hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <button id="new-chat-btn" class="w-full flex items-center justify-center gap-2 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                <span class="text-white">New Chat</span>
            </button>
            <div class="flex-grow overflow-y-auto custom-scrollbar">
                </div>
            <div class="border-t border-gray-700 pt-4 space-y-2">
                <button id="rate-us-btn" class="w-full flex items-center gap-3 py-2 px-3 rounded-md text-sm hover:bg-gray-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                    Rate Us
                </button>
                <form method="post" action="{% url 'logout' %}">
                    {% csrf_token %}
                    <button type="submit" class="w-full flex items-center gap-3 py-2 px-3 rounded-md text-sm text-red-400 hover:bg-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V5h10a1 1 0 100-2H3zm12.293 4.293a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L16.586 13H9a1 1 0 110-2h7.586l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        Logout
                    </button>
                </form>
            </div>
        </div>
    </aside>

    <div class="hidden lg:flex items-center bg-gray-900 border-l border-gray-800">
        <button id="desktop-sidebar-toggle" class="h-12 px-1 flex items-center justify-center text-gray-400 hover:text-white transition-colors">
            <img id="desktop-sidebar-icon" src="{% static 'images/dock_to_left.png' %}" class="w-5 h-5" alt="Toggle Sidebar">
        </button>
    </div>

    <main class="flex-1 flex flex-col h-screen bg-gray-800">
        <header class="flex-shrink-0 bg-gray-900/50 backdrop-blur-sm p-4 border-b border-gray-700 lg:hidden">
            <button onclick="toggleSidebar()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m-8 6h16" /></svg>
            </button>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto custom-scrollbar">
            <div id="chat-messages" class="max-w-3xl mx-auto p-4 md:p-6 space-y-8">
                <div id="welcome-screen" class="text-center py-16">
                    <div class="inline-block bg-gradient-to-r from-green-500 to-green-400 p-4 rounded-full mb-6">
                         <img src="{% static 'images/vinebotLogo.png' %}" alt="vinebotLogo" class="mx-auto w-36 h-32 rounded-full">
                    </div>
                    <h2 class="text-4xl font-bold text-white mb-2">How can I help you today?</h2>
                    <p class="text-gray-400">Ask me anything, or try one of the suggestions below.</p>
                </div>
                 </div>
        </div>

        <div class="flex-shrink-0 p-4 bg-gray-800">
            <div class="max-w-3xl mx-auto">
                <div id="suggestions" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                    <div class="suggestion-card bg-green-700/50 p-4 rounded-lg hover:bg-gray-700 cursor-pointer"><p>What is worship ministry?</p></div>
                    <div class="suggestion-card bg-green-700/50 p-4 rounded-lg hover:bg-gray-700 cursor-pointer"><p>What is product ministry?</p></div>
                    <div class="suggestion-card bg-green-700/50 p-4 rounded-lg hover:bg-gray-700 cursor-pointer"><p>How to do the activities and events?</p></div>
                    <div class="suggestion-card bg-green-700/50 p-4 rounded-lg hover:bg-gray-700 cursor-pointer"><p>What is care support ministry?</p></div>
                </div>
                <form id="chat-form" class="relative">
                    <textarea id="chat-input" placeholder="Message VineBot..." class="w-full bg-gray-700 text-gray-200 rounded-lg p-4 pr-20 resize-none focus:outline-none focus:ring-2 focus:ring-green-500 transition-shadow" rows="1"></textarea>
                    <button id="send-btn" type="submit" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 bg-green-500 rounded-full text-white hover:bg-green-700 disabled:bg-green-800 disabled:cursor-not-allowed transition-colors" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                    </button>
                </form>
            </div>
        </div>
    </main>

    <div id="rating-modal" class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 max-w-sm w-full relative">
            <div class="absolute top-4 right-4">
                <div class="relative">
                    <button class="three-dot-menu-btn p-2 rounded-full hover:bg-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
                        </svg>
                    </button>
                    <div class="dropdown-menu hidden absolute right-0 mt-2 w-32 bg-gray-700 rounded-md shadow-lg py-1 z-10">
                        <button class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-600 transition-colors">Rename</button>
                        <button class="block w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-gray-600 transition-colors">Delete</button>
                    </div>
                </div>
            </div>
            
            <h3 class="text-2xl font-bold text-white mb-4">Rate Your Experience</h3>
            <div class="flex justify-center space-x-2 mb-6 star-rating">
                <button data-value="1" class="text-3xl text-gray-500 hover:text-yellow-400 transition-colors">★</button>
                <button data-value="2" class="text-3xl text-gray-500 hover:text-yellow-400 transition-colors">★</button>
                <button data-value="3" class="text-3xl text-gray-500 hover:text-yellow-400 transition-colors">★</button>
                <button data-value="4" class="text-3xl text-gray-500 hover:text-yellow-400 transition-colors">★</button>
                <button data-value="5" class="text-3xl text-gray-500 hover:text-yellow-400 transition-colors">★</button>
            </div>
            <div class="w-full mb-4">
                <input type="text" placeholder="Type something..." class="w-full bg-gray-700 text-gray-200 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            <div class="flex justify-end gap-4">
                <button id="close-modal-btn" class="py-2 px-4 rounded-lg bg-gray-600 hover:bg-gray-500 transition-colors">Close</button>
                <button id="submit-rating-btn" class="py-2 px-4 rounded-lg bg-blue-600 hover:bg-blue-700 transition-colors">Submit</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const chatForm = document.getElementById('chat-form');
    const chatMessages = document.getElementById('chat-messages');
    const welcomeScreen = document.getElementById('welcome-screen');
    const suggestionsContainer = document.getElementById('suggestions');
    const newChatBtn = document.getElementById('new-chat-btn');
    const desktopSidebarToggle = document.getElementById('desktop-sidebar-toggle');
    const desktopSidebarIcon = document.getElementById('desktop-sidebar-icon');
    const sidebarContent = document.getElementById('sidebar-content');
    const dockLeftUrl = `{% static 'images/dock_to_left.png' %}`;
    const dockRightUrl = `{% static 'images/dock_to_right.png' %}`;
    const rateUsBtn = document.getElementById('rate-us-btn');
    const ratingModal = document.getElementById('rating-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const starRatingContainer = ratingModal.querySelector('.star-rating');
    const modalMenuBtn = ratingModal.querySelector('.three-dot-menu-btn');
    const modalDropdown = ratingModal.querySelector('.dropdown-menu'); // <-- CORRECTED THIS LINE
    

    let currentRating = 0;
    let currentChatId = null;
    const chatListContainer = sidebar.querySelector('.flex-grow');

    // ================= Sidebar Toggle =================
    window.toggleSidebar = () => {
        sidebar.classList.toggle('-translate-x-full');
        sidebarOverlay.classList.toggle('hidden');
    };

    desktopSidebarToggle.addEventListener('click', () => {
        const isCollapsed = sidebar.classList.contains('w-0');
        if (isCollapsed) {
            sidebar.classList.remove('w-0', 'p-0');
            sidebar.classList.add('w-64', 'p-4');
            sidebarContent.classList.remove('hidden');
            desktopSidebarIcon.src = dockLeftUrl;
        } else {
            sidebar.classList.remove('w-64', 'p-4');
            sidebar.classList.add('w-0', 'p-0');
            sidebarContent.classList.add('hidden');
            desktopSidebarIcon.src = dockRightUrl;
        }
    });

    // ================= Chat Handling =================
    async function fetchChats() {
        const res = await fetch("/chat/history/");
        if (!res.ok) return;
        const data = await res.json();
        renderChatList(data.chats);
    }

    function renderChatList(chats) {
        chatListContainer.innerHTML = "";
        chats.forEach(chat => {
            const chatItem = document.createElement("div");
            chatItem.className = "group flex items-center justify-between px-3 py-2 rounded-lg hover:bg-gray-700 cursor-pointer relative";
            chatItem.dataset.chatId = chat.id;

            const titleSpan = document.createElement("span");
            titleSpan.textContent = chat.title;
            titleSpan.className = "flex-1 truncate";
            chatItem.appendChild(titleSpan);

            const menuBtn = document.createElement("button");
            menuBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
            </svg>`;
            menuBtn.className = "opacity-0 group-hover:opacity-100 text-gray-400 hover:text-white ml-2 p-1 rounded hover:bg-gray-600 transition-all duration-200";
            menuBtn.onclick = (e) => {
                e.stopPropagation();
                showChatMenu(menuBtn, chat.id, chat.title);
            };
            chatItem.appendChild(menuBtn);

            chatItem.addEventListener("click", () => loadChat(chat.id));
            chatListContainer.appendChild(chatItem);
        });
    }

    async function createChat() {
        const res = await fetch("/chat/new/", { method: "POST" });
        if (!res.ok) return;
        const data = await res.json();
        currentChatId = data.chat_id;
        await fetchChats();

        chatMessages.innerHTML = "";
        chatMessages.appendChild(welcomeScreen);
        welcomeScreen.style.display = "block";
        suggestionsContainer.style.display = "grid";
        if (window.innerWidth < 1024) toggleSidebar();
    }

    async function loadChat(chatId) {
        currentChatId = chatId;
        const res = await fetch(`/chat/${chatId}/messages/`);
        if (!res.ok) return;
        const data = await res.json();

        chatMessages.innerHTML = "";
        if (data.length === 0) {
            chatMessages.appendChild(welcomeScreen);
            welcomeScreen.style.display = "block";
            suggestionsContainer.style.display = "grid";
        } else {
            welcomeScreen.style.display = "none";
            suggestionsContainer.style.display = "none";
            data.forEach(msg => {
                appendMessage(msg.sender, msg.content);
            });
        }
    }

    async function renameChat(chatId, oldTitle) {
        const newTitle = prompt("Enter new chat title:", oldTitle);
        if (!newTitle) return;
        await fetch(`/chat/${chatId}/rename/`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({title: newTitle})
        });
        await fetchChats();
    }

    async function deleteChat(chatId) {
        if (!confirm("Delete this chat?")) return;
        await fetch(`/chat/${chatId}/delete/`, { method: "POST" });
        if (chatId === currentChatId) {
            currentChatId = null;
            chatMessages.innerHTML = "";
            chatMessages.appendChild(welcomeScreen);
            welcomeScreen.style.display = "block";
            suggestionsContainer.style.display = "grid";
        }
        await fetchChats();
    }

    function showChatMenu(button, chatId, oldTitle) {
        // Remove any existing menus
        document.querySelectorAll('.chat-menu-dropdown').forEach(menu => menu.remove());
        
        const menu = document.createElement("div");
        menu.className = "chat-menu-dropdown absolute right-0 mt-1 bg-gray-800 border border-gray-700 rounded-md shadow-md z-50";
        menu.innerHTML = `
            <button class="block w-full px-4 py-2 text-left text-sm hover:bg-gray-700 transition-colors">Rename</button>
            <button class="block w-full px-4 py-2 text-left text-sm text-red-400 hover:bg-gray-700 transition-colors">Delete</button>
        `;
        
        // Position relative to button
        const rect = button.getBoundingClientRect();
        const parentRect = button.parentElement.getBoundingClientRect();
        menu.style.width = '120px';
        
        // Add menu to button's parent
        button.parentElement.appendChild(menu);
        
        const removeMenu = () => {
            menu.remove();
            document.removeEventListener("click", removeMenu);
        };

        menu.children[0].onclick = (e) => { 
            e.stopPropagation();
            renameChat(chatId, oldTitle); 
            removeMenu(); 
        };
        menu.children[1].onclick = (e) => { 
            e.stopPropagation();
            deleteChat(chatId); 
            removeMenu(); 
        };

        setTimeout(() => document.addEventListener("click", removeMenu), 0);
    }

    // ================= Sending Messages =================
    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (!message) return;

        if (!currentChatId) {
            await createChat();
        }

        if (welcomeScreen.style.display !== 'none') {
            welcomeScreen.style.display = 'none';
            suggestionsContainer.style.display = 'none';
        }

        appendMessage('user', message);
        chatInput.value = '';
        chatInput.style.height = 'auto';
        sendBtn.disabled = true;

        try {
            const response = await fetch("{% url 'chat_api' %}", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ message: message, chat_id: currentChatId })
            });
            const data = await response.json();
            if (data.reply) {
                appendMessage('bot', data.reply);
            } else {
                appendMessage('bot', "Sorry, I couldn't generate a response");
            }
        } catch (error) {
            appendMessage('bot', "Error:" + error.message);
        }
        await fetchChats();
    });

    // ================= Helpers =================
    function appendMessage(sender, text) {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `flex items-start gap-4 ${sender === 'user' ? 'justify-end' : ''}`;
        
        const messageBubble = document.createElement('div');
        messageBubble.className = `max-w-xl p-4 rounded-2xl ${sender === 'user' ? 'bg-green-600 text-white rounded-br-none' : 'bg-gray-700 text-gray-200 rounded-bl-none'}`;
        
        if (sender === 'bot' && text.startsWith('This is a simulated response to:')) {
            messageBubble.innerHTML = '<div class="flex items-center gap-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse [animation-delay:0.2s]"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse [animation-delay:0.4s]"></div></div>';
            setTimeout(() => {
                messageBubble.textContent = text;
            }, 1000);
        } else {
            messageBubble.textContent = text;
        }

        if (sender === 'user') {
            messageWrapper.appendChild(messageBubble);
        } else {
            const botAvatar = document.createElement('img');
            botAvatar.className = 'w-10 h-10 rounded-full flex-shrink-0';
            botAvatar.src = "{% static 'images/vinebotLogo.png' %}";
            messageWrapper.appendChild(botAvatar);
            messageWrapper.appendChild(messageBubble);
        }

        chatMessages.appendChild(messageWrapper);
        chatMessages.parentElement.scrollTop = chatMessages.parentElement.scrollHeight;
    }

    // --- Textarea Auto-grow and Send Button Logic ---
    chatInput.addEventListener('input', () => {
        chatInput.style.height = 'auto';
        chatInput.style.height = `${chatInput.scrollHeight}px`;
        sendBtn.disabled = chatInput.value.trim() === '';
    });
    
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatForm.dispatchEvent(new Event('submit'));
        }
    });

    // --- New Chat Button ---
    newChatBtn.addEventListener('click', () => {
        currentChatId = null;
        chatMessages.innerHTML = '';
        chatMessages.appendChild(welcomeScreen);
        welcomeScreen.style.display = 'block';
        suggestionsContainer.style.display = 'grid';
        if (window.innerWidth < 1024) toggleSidebar();
    });

    // --- Suggestion Cards ---
    suggestionsContainer.addEventListener('click', (e) => {
        const card = e.target.closest('.suggestion-card');
        if (card) {
            const prompt = card.querySelector('p').textContent;
            chatInput.value = prompt;
            chatForm.dispatchEvent(new Event('submit'));
        }
    });

    // --- Rating Modal Logic ---
    rateUsBtn.addEventListener('click', () => {
        ratingModal.style.display = 'flex';
    });

    closeModalBtn.addEventListener('click', () => {
        ratingModal.style.display = 'none';
    });

    ratingModal.addEventListener('click', (e) => {
        if (e.target === ratingModal) {
            ratingModal.style.display = 'none';
        }
    });

    starRatingContainer.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            currentRating = parseInt(e.target.dataset.value);
            updateStars();
        }
    });

    starRatingContainer.addEventListener('mouseover', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const hoverValue = parseInt(e.target.dataset.value);
            updateStars(hoverValue, true);
        }
    });

    starRatingContainer.addEventListener('mouseout', () => {
        updateStars();
    });

    function updateStars(hoverValue = 0, isHovering = false) {
        const stars = starRatingContainer.querySelectorAll('button');
        const displayValue = isHovering ? hoverValue : currentRating;
        stars.forEach(star => {
            if (parseInt(star.dataset.value) <= displayValue) {
                star.classList.remove('text-gray-500');
                star.classList.add('text-yellow-400');
            } else {
                star.classList.add('text-gray-500');
                star.classList.remove('text-yellow-400');
            }
        });
    }

    // --- Three-dot menu for Rating Modal ---
    
    modalMenuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        modalDropdown.classList.toggle('hidden');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!modalMenuBtn.contains(e.target) && !modalDropdown.contains(e.target)) {
            modalDropdown.classList.add('hidden');
        }
    });

    // Handle modal menu actions (UI only, no backend logic)
    modalDropdown.querySelectorAll('button').forEach((btn, index) => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (index === 0) {
                console.log('Rename rating clicked');
                // Add rename UI logic here
            } else {
                console.log('Delete rating clicked');
                // Add delete UI logic here
            }
            modalDropdown.classList.add('hidden');
        });
    });

    // ================= Init =================
    fetchChats();
});
</script>

<style>
/* Add smooth transitions for hover effects */
.group:hover .opacity-0 {
    opacity: 1;
}

/* Custom scrollbar styles */
.custom-scrollbar::-webkit-scrollbar {
    width: 8px;
}

.custom-scrollbar::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
}

.custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background-color: rgba(255, 255, 255, 0.3);
}

/* Dropdown menu animations */
.chat-menu-dropdown,
.dropdown-menu {
    animation: fadeIn 0.2s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-4px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

</div>
{% endblock %}