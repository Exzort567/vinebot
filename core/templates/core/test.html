{% extends 'base.html' %}
{% load static %}

{% block title %}VineBot{% endblock %}

{% block content %}
<div class="bg-gray-800 text-gray-200 flex h-screen overflow-hidden">

    <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-30 hidden lg:hidden" onclick="toggleSidebar()"></div>

    <aside id="sidebar" class="bg-gray-900 w-64 h-full flex flex-col p-4 fixed lg:relative transition-all duration-300 ease-in-out -translate-x-full lg:translate-x-0 z-40">
        <div id="sidebar-content" class="h-full flex flex-col min-w-[224px]">
            <div class="flex items-center justify-between mb-8">
                <h1 class="text-2xl font-bold text-white"><span class="text-green-300">Vine</span><span class="text-purple-400">Bot</span></h1>
                <button onclick="toggleSidebar()" class="lg:hidden p-1 rounded-md hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <button id="new-chat-btn" class="w-full flex items-center justify-center gap-2 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                <span class="text-white">New Chat</span>
            </button>
            <div class="flex-grow overflow-y-auto custom-scrollbar">
                </div>
            <div class="border-t border-gray-700 pt-4 space-y-2">
                <button id="rate-us-btn" class="w-full flex items-center gap-3 py-2 px-3 rounded-md text-sm hover:bg-gray-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                    Rate Us
                </button>
                <form method="post" action="{% url 'logout' %}">
                    {% csrf_token %}
                    <button type="submit" class="w-full flex items-center gap-3 py-2 px-3 rounded-md text-sm text-red-400 hover:bg-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V5h10a1 1 0 100-2H3zm12.293 4.293a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L16.586 13H9a1 1 0 110-2h7.586l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        Logout
                    </button>
                </form>
            </div>
        </div>
    </aside>

    <div class="hidden lg:flex items-center bg-gray-900 border-l border-gray-800">
        <button id="desktop-sidebar-toggle" class="h-12 px-1 flex items-center justify-center text-gray-400 hover:text-white transition-colors">
            <img id="desktop-sidebar-icon" src="{% static 'images/dock_to_left.png' %}" class="w-5 h-5" alt="Toggle Sidebar">
        </button>
    </div>

    <main class="flex-1 flex flex-col h-screen bg-gray-800">
        <header class="flex-shrink-0 bg-gray-900/50 backdrop-blur-sm p-4 border-b border-gray-700 lg:hidden">
            <button onclick="toggleSidebar()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m-8 6h16" /></svg>
            </button>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto custom-scrollbar">
            <div id="chat-messages" class="max-w-3xl mx-auto p-4 md:p-6 space-y-8">
                <div id="welcome-screen" class="text-center py-16">
                    <div class="inline-block bg-gradient-to-r from-green-500 to-green-400 p-4 rounded-full mb-6">
                         <img src="{% static 'images/vinebotLogo.png' %}" alt="vinebotLogo" class="mx-auto w-36 h-32 rounded-full">
                    </div>
                    <h2 class="text-4xl font-bold text-white mb-2">How can I help you today?</h2>
                    <p class="text-gray-400">Ask me anything, or try one of the suggestions below.</p>
                </div>
                 </div>
        </div>

        <div class="flex-shrink-0 p-4 bg-gray-800">
            <div class="max-w-3xl mx-auto">
                <div id="suggestions" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                    <div class="suggestion-card bg-green-700/50 p-4 rounded-lg hover:bg-gray-700 cursor-pointer"><p>What is worship ministry?</p></div>
                    <div class="suggestion-card bg-green-700/50 p-4 rounded-lg hover:bg-gray-700 cursor-pointer"><p>What is product ministry?</p></div>
                    <div class="suggestion-card bg-green-700/50 p-4 rounded-lg hover:bg-gray-700 cursor-pointer"><p>How to do the activities and events?</p></div>
                    <div class="suggestion-card bg-green-700/50 p-4 rounded-lg hover:bg-gray-700 cursor-pointer"><p>What is care support ministry?</p></div>
                </div>
                <form id="chat-form" class="relative">
                    <textarea id="chat-input" placeholder="Message VineBot..." class="w-full bg-gray-700 text-gray-200 rounded-lg p-4 pr-20 resize-none focus:outline-none focus:ring-2 focus:ring-green-500 transition-shadow" rows="1"></textarea>
                    <button id="send-btn" type="submit" class="absolute right-3 top-1/2 -translate-y-1/2 p-2 bg-green-500 rounded-full text-white hover:bg-green-700 disabled:bg-green-800 disabled:cursor-not-allowed transition-colors" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                    </button>
                </form>
            </div>
        </div>
    </main>


    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const chatForm = document.getElementById('chat-form');
    const chatMessages = document.getElementById('chat-messages');
    const welcomeScreen = document.getElementById('welcome-screen');
    const suggestionsContainer = document.getElementById('suggestions');
    const newChatBtn = document.getElementById('new-chat-btn');
    const desktopSidebarToggle = document.getElementById('desktop-sidebar-toggle');
    const desktopSidebarIcon = document.getElementById('desktop-sidebar-icon');
    const sidebarContent = document.getElementById('sidebar-content');
    const dockLeftUrl = `{% static 'images/dock_to_left.png' %}`;
    const dockRightUrl = `{% static 'images/dock_to_right.png' %}`;
    const rateUsBtn = document.getElementById('rate-us-btn');
    const ratingModal = document.getElementById('rating-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const starRatingContainer = ratingModal.querySelector('.star-rating');
    const modalMenuBtn = ratingModal.querySelector('.three-dot-menu-btn');
    const modalDropdown = ratingModal.querySelector('.dropdown-menu'); // <-- CORRECTED THIS LINE
    

    let currentRating = 0;
    let currentChatId = null;
    const chatListContainer = sidebar.querySelector('.flex-grow');



    // ================= Sending Messages =================
    // REPLACE your entire 'chatForm.addEventListener' with this new version
    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (!message) return;

        if (!currentChatId) {
            await createChat();
        }

        if (welcomeScreen.style.display !== 'none') {
            welcomeScreen.style.display = 'none';
            suggestionsContainer.style.display = 'none';
        }

        appendMessage('user', message); // This function is still used for user messages
        chatInput.value = '';
        chatInput.style.height = 'auto';
        sendBtn.disabled = true;

        // ✨ Change: Create a dedicated formatting function
        // This function intelligently adds line breaks and bolding for a clean look.
        function formatBotResponse(text) {
            // Sanitize to prevent basic HTML injection
            let safeText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");

            // Use regex to format the Q&A structure and numbered lists
            return safeText
                .replace(/\bQ: /g, '<br><br><strong>Q:</strong> ')
                .replace(/\bA: /g, '<br><strong>A:</strong> ')
                .replace(/\((\d+)\)/g, '<br>($1)')
                .replace(/^<br><br>/, ''); // Remove leading breaks
        }

        try {
            const response = await fetch("{% url 'chat_api_stream' %}", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken") },
                body: JSON.stringify({ message: message, chat_id: currentChatId })
            });

            if (!response.ok) {
                appendMessage('bot', "Error: failed to connect to streaming API");
                return;
            }

            // ✨ Change: Create bot message elements with placeholders for text and a cursor
            const botWrapper = document.createElement('div');
            botWrapper.className = "flex items-start gap-4";
            
            const botAvatar = document.createElement('img');
            botAvatar.className = 'w-10 h-10 rounded-full flex-shrink-0';
            botAvatar.src = "{% static 'images/vinebotLogo.png' %}";
            
            const botBubble = document.createElement('div');
            botBubble.className = "max-w-xl p-4 rounded-2xl bg-gray-700 text-gray-200 rounded-bl-none";
            
            const botTextSpan = document.createElement('span'); // To hold the formatted text
            const typingCursor = document.createElement('span'); // The blinking cursor
            typingCursor.className = 'typing-indicator';
            
            botBubble.appendChild(botTextSpan);
            botBubble.appendChild(typingCursor);
            botWrapper.appendChild(botAvatar);
            botWrapper.appendChild(botBubble);
            chatMessages.appendChild(botWrapper);
            chatMessages.parentElement.scrollTop = chatMessages.parentElement.scrollHeight;

            // ✨ Change: Read the stream and update the botTextSpan using innerHTML
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let botText = "";

            while (true) {
                const { value, done } = await reader.read();
                if (done) {
                    typingCursor.remove(); // ✨ Change: Remove cursor when finished
                    break;
                }
                const chunk = decoder.decode(value, { stream: true });

                chunk.split("\n").forEach(line => {
                    if (line.startsWith("data: ")) {
                        const text = line.replace("data: ", "").trim();
                        if (text && text !== "[DONE]") {
                            botText += text;
                            // ✨ Change: Use the formatter and innerHTML
                            botTextSpan.innerHTML = formatBotResponse(botText); 
                            chatMessages.parentElement.scrollTop = chatMessages.parentElement.scrollHeight;
                        }
                    }
                });
            }
        } catch (error) {
            appendMessage('bot', "Error:" + error.message);
        }

        await fetchChats();
    });

    // ================= Helpers =================
    function appendMessage(sender, text) {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `flex items-start gap-4 ${sender === 'user' ? 'justify-end' : ''}`;
        
        const messageBubble = document.createElement('div');
        messageBubble.className = `max-w-xl p-4 rounded-2xl ${sender === 'user' ? 'bg-green-600 text-white rounded-br-none' : 'bg-gray-700 text-gray-200 rounded-bl-none'}`;
        
        if (sender === 'bot' && text.startsWith('This is a simulated response to:')) {
            messageBubble.innerHTML = '<div class="flex items-center gap-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse [animation-delay:0.2s]"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse [animation-delay:0.4s]"></div></div>';
            setTimeout(() => {
                messageBubble.textContent = text;
            }, 1000);
        } else {
            messageBubble.textContent = text;
        }

        if (sender === 'user') {
            messageWrapper.appendChild(messageBubble);
        } else {
            const botAvatar = document.createElement('img');
            botAvatar.className = 'w-10 h-10 rounded-full flex-shrink-0';
            botAvatar.src = "{% static 'images/vinebotLogo.png' %}";
            messageWrapper.appendChild(botAvatar);
            messageWrapper.appendChild(messageBubble);
        }

        chatMessages.appendChild(messageWrapper);
        chatMessages.parentElement.scrollTop = chatMessages.parentElement.scrollHeight;
    }

    // --- Textarea Auto-grow and Send Button Logic ---
    chatInput.addEventListener('input', () => {
        chatInput.style.height = 'auto';
        chatInput.style.height = `${chatInput.scrollHeight}px`;
        sendBtn.disabled = chatInput.value.trim() === '';
    });
    
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatForm.dispatchEvent(new Event('submit'));
        }
    });

  

    // ================= Init =================
    fetchChats();
});
</script>

<style>
    /* Add this to your <style> block */
.typing-indicator {
    display: inline-block;
    width: 2px;
    height: 1.1em;
    background-color: #9ca3af; /* gray-400 */
    animation: blink 1s step-end infinite;
    vertical-align: bottom;
    margin-left: 4px;
}

@keyframes blink {
    from, to { background-color: transparent; }
    50% { background-color: #9ca3af; } /* gray-400 */
}
/* Add smooth transitions for hover effects */
.group:hover .opacity-0 {
    opacity: 1;
}

/* Custom scrollbar styles */
.custom-scrollbar::-webkit-scrollbar {
    width: 8px;
}

.custom-scrollbar::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
}

.custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background-color: rgba(255, 255, 255, 0.3);
}

/* Dropdown menu animations */
.chat-menu-dropdown,
.dropdown-menu {
    animation: fadeIn 0.2s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-4px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

</div>
{% endblock %}